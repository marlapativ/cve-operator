pipeline {
    environment {
        imageRegistry = "docker.io"
        imageRepo = "marlapativ"
        imageName = "cve-operator"
        registryCredential = 'dockerhub'
    }
    agent any
    stages {
        stage('helm chart validations') {
            parallel {
                stage('helm lint') {
                    steps {
                        sh '''
                            helm lint charts/helm-cve-operator --strict
                            helm lint charts/helm-cve-operator-app --strict
                        '''
                    }
                }

                stage('helm template') {
                    steps {
                        sh '''
                            helm template charts/helm-cve-operator
                            helm template charts/helm-cve-operator-app
                        '''
                    }
                }
            }
        }

        stage('setup docker') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: registryCredential, passwordVariable: 'password', usernameVariable: 'username')]) {
                        sh('docker login -u $username -p $password')
                    }
                }
            }
        }

        stage('github release') {
            tools {
                nodejs "nodejs"
            }
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'github-app', passwordVariable: 'GITHUB_TOKEN', usernameVariable: 'GITHUB_USERNAME')]) {
                        sh '''
                            npm i -g @semantic-release/exec
                            export GITHUB_ACTION=true
                            npx semantic-release
                        '''
                    }
                }
            }
        }

        stage('build and push cve-operator image') {
            steps {
                    sh '''
                        export IMAGE_TAG=$(git describe --tags --abbrev=0)
                        
                        make docker-buildx IMG=$imageRepo/$imageName:$IMAGE_TAG IMG_LATEST=$imageRepo/$imageName:latest
                    '''
            }
        }

        stage('helm chart release') {
            steps {
                script {
                    sh '''
                        cd charts/helm-cve-operator
                        helm push *.tgz oci://$imageRegistry/$imageRepo
                        cd ../helm-cve-operator-app
                        helm push *.tgz oci://$imageRegistry/$imageRepo
                    '''
                }
            }
        }
    }
}
